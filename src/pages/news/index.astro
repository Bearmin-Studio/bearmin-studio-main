---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { client, type News, type MicroCMSListResponse } from '../../lib/microcms';

let newsList: News[] = [];
let fetchError = false;

try {
  const response = await client.get<MicroCMSListResponse<News>>({
    endpoint: 'news',
    queries: { limit: 20 },
  });
  newsList = response.contents;
} catch (e) {
  fetchError = true;
}

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return new Intl.DateTimeFormat('ja-JP', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    timeZone: 'Asia/Tokyo'
  }).format(date).replace(/\//g, '.');
};
---

<BaseLayout
  title="お知らせ"
  description="Bearmin Studio | ベアミンスタジオからのお知らせ一覧です。制作実績の更新や最新情報をお届けします。"
>

  <Breadcrumb items={[{ label: 'お知らせ' }]} />

  <div class="page-header">
    <p class="eyebrow">News</p>
    <h1 class="page-title">お知らせ</h1>
  </div>

  <section class="news-section">
    <div class="news-wrap">
      {fetchError ? (
        <p class="news-empty">お知らせを取得できませんでした。</p>
      ) : newsList.length === 0 ? (
        <p class="news-empty">現在、お知らせはありません。</p>
      ) : (
        <div class="news-list">
          {newsList.map((news) => (
            <a href={`/news/${news.id}`} class="news-item">
              <span class="news-date">{formatDate(news.date || news.publishedAt)}</span>
              <div class="news-body">
                {news.tags && news.tags.length > 0 && (
                  <div class="news-tags">
                    {news.tags.map((tag) => (
                      <span class="news-tag">#{tag}</span>
                    ))}
                  </div>
                )}
                <p class="news-title">{news.title}</p>
                {news.excerpt && <p class="news-excerpt">{news.excerpt}</p>}
              </div>
              <span class="news-arrow" aria-hidden="true">→</span>
            </a>
          ))}
        </div>
      )}
    </div>
  </section>

</BaseLayout>

<style>
  .page-header {
    padding-top: 2.5rem;
  }

  @media (max-width: 768px) {
    .page-header {
      padding-top: 1.5rem;
    }
  }

  .eyebrow {
    font-family: var(--font-accent);
    font-size: 0.6875rem;
    letter-spacing: 0.22em;
    color: var(--moss-green);
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .news-section {
    background: var(--soft-white);
    padding: 3rem 2rem 8rem;
  }

  .news-wrap {
    max-width: 720px;
    margin: 0 auto;
  }

  .news-list {
    border-top: 1px solid rgba(107, 78, 61, 0.12);
  }

  .news-item {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    padding: 1.375rem 0;
    border-bottom: 1px solid rgba(107, 78, 61, 0.1);
    text-decoration: none;
    color: var(--charcoal);
    transition: opacity 0.2s ease;
  }

  .news-item:hover {
    opacity: 0.65;
  }

  .news-date {
    font-size: 0.8125rem;
    color: var(--bear-brown);
    white-space: nowrap;
    min-width: 5.5rem;
    flex-shrink: 0;
    letter-spacing: 0.02em;
  }

  .news-body {
    flex: 1;
    min-width: 0;
  }

  .news-tags {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
    flex-wrap: wrap;
  }

  .news-tag {
    font-size: 0.75rem;
    color: var(--moss-green);
    background: rgba(90, 111, 88, 0.1);
    padding: 0.1rem 0.5rem;
    border-radius: 4px;
    white-space: nowrap;
  }

  .news-title {
    font-size: 0.9375rem;
    line-height: 1.6;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    transition: color 0.2s ease;
  }

  .news-item:hover .news-title {
    color: var(--moss-green);
  }

  .news-excerpt {
    font-size: 0.8125rem;
    opacity: 0.6;
    line-height: 1.7;
    margin-top: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .news-arrow {
    font-size: 0.875rem;
    color: var(--bear-brown);
    opacity: 0.35;
    flex-shrink: 0;
    transition: opacity 0.2s ease, transform 0.2s ease;
  }

  .news-item:hover .news-arrow {
    opacity: 0.85;
    transform: translateX(3px);
  }

  .news-empty {
    text-align: center;
    padding: 4rem 0;
    font-size: 0.9375rem;
    opacity: 0.6;
  }

  @media (max-width: 768px) {
    .news-section {
      padding: 2rem 1.5rem 6rem;
    }

    .news-title {
      white-space: normal;
    }

    .news-excerpt {
      white-space: normal;
    }

    .news-arrow {
      display: none;
    }
  }
</style>
